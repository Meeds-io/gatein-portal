<?xml version="1.0" encoding="UTF-8"?>

<project name="package" xmlns:mvn="http://maven.apache.org/POM/4.0.0">

   <property name="samples.dir" value="${maven.project.basedir}/src/main/resources/jpp/samples" />
   <property name="cluster.dir" value="${maven.project.basedir}/src/main/resources/jpp/cluster" />

   <target name="prepare" depends="prepare-server-dir,package">
   </target>

   <target name="server-dir-check">
      <available property="jbossas.dir.exists" type="dir" file="${jbossas.dir}" />
   </target>

   <target name="server-exist-msg" depends="server-dir-check" if="jbossas.dir.exists">
      <echo message="JBossAS directory exists already. Using existing one ..."/>
   </target>

   <target name="prepare-server-dir" depends="server-dir-check,server-exist-msg" unless="jbossas.dir.exists">
      <property name="jbossas.zip" value="${servers.dir}/jboss-as-dist-${jbossas.dist.version}.zip"/>

      <!-- Autocreate servers.dir if necessary -->
      <mkdir dir="${servers.dir}" />

      <!-- Download JBossAS unless already downloaded -->
      <ant antfile="${maven.project.basedir}/download-jboss.xml">
         <target name="download-jboss"/>
         <property name="url" value="http://repository.jboss.org/nexus/content/groups/public/org/jboss/as/jboss-as-dist/${jbossas.dist.version}/jboss-as-dist-${jbossas.dist.version}.zip"/>
         <property name="dest" value="${jbossas.zip}"/>
      </ant>

      <!-- Extract downloaded JBossAS to servers dir -->
      <unzip src="${jbossas.zip}" dest="${servers.dir}" overwrite="false" />
   </target>

   <target name="package-cluster-checkdir">
      <condition property="pkg.cluster.hasdir">
         <available file="${cluster.dir}" type="dir"/>
      </condition>
   </target>

   <target name="package-cluster-copy" depends="package-cluster-checkdir" if="pkg.cluster.hasdir">
      <!-- Copy version specific bin, modules, configuration files -->
      <copy todir="${jbossas.target.dir}" preservelastmodified="true" overwrite="true">
         <fileset dir="${cluster.dir}" />
      </copy>
   </target>

   <target name="package-cluster" if="pkg.cluster">
      <!-- Package cluster specific configuration if requested -->
      <antcall target="package-cluster-copy" inheritAll="true" inheritRefs="true"/>
   </target>

   <target name="package-samples-checkdir">
      <condition property="pkg.samples.hasdir">
         <available file="${samples.dir}" type="dir"/>
      </condition>
   </target>

   <target name="package-samples-copy" depends="package-samples-checkdir" if="pkg.samples.hasdir">
      <!-- Copy version specific bin, modules, configuration files -->
      <copy todir="${jbossas.target.dir}" preservelastmodified="true" overwrite="true">
         <fileset dir="${samples.dir}" />
      </copy>
   </target>

   <target name="package-samples" unless="pkg.nosamples">
      <!-- The following is commented out because of GTNPORTAL-2639 -->
 	  <!--
      <copy todir="${jbossas.target.dir}/gatein/extensions/gatein-sample-portal.ear/lib" >
         <fileset refid="org.gatein.portal:exo.portal.sample.portal.config:jar"/>
      </copy>
      <copy todir="${jbossas.target.dir}/gatein/extensions/gatein-sample-portal.ear/lib" >
         <fileset refid="org.gatein.portal:exo.portal.sample.portal.jar:jar"/>
      </copy>
      <copy tofile="${jbossas.target.dir}/gatein/extensions/gatein-sample-portal.ear/sample-portal.war" >
         <fileset refid="org.gatein.portal:exo.portal.sample.portal.war:war"/>
      </copy>
      <copy tofile="${jbossas.target.dir}/gatein/extensions/gatein-sample-portal.ear/rest-sample-portal.war" >
         <fileset refid="org.gatein.portal:exo.portal.sample.portal.rest-war:war"/>
      </copy>
 	  -->

      <!-- The following is commented out because of GTNPORTAL-2639 -->
   	  <!--
      <copy todir="${jbossas.target.dir}/gatein/extensions/gatein-sample-extension.ear/lib" >
         <fileset refid="org.gatein.portal:exo.portal.sample.extension.config:jar"/>
      </copy>
      <copy todir="${jbossas.target.dir}/gatein/extensions/gatein-sample-extension.ear/lib" >
         <fileset refid="org.gatein.portal:exo.portal.sample.extension.jar:jar"/>
      </copy>
      <copy tofile="${jbossas.target.dir}/gatein/extensions/gatein-sample-extension.ear/sample-ext.war" >
         <fileset refid="org.gatein.portal:exo.portal.sample.extension.war:war"/>
      </copy>

      <copy tofile="${jbossas.target.dir}/gatein/extensions/gatein-sample-skin.war">
         <fileset refid="org.gatein.portal.examples.skins:gatein-sample-skin:war"/>
      </copy>
   	  -->

      <!-- Copy non-version-specific samples resources -->
      <!-- The following is commented out because of GTNPORTAL-2639 -->
   	  <!--
      <copy todir="${jbossas.target.dir}" preservelastmodified="true" overwrite="true">
         <fileset dir="${maven.project.basedir}/src/main/resources/jboss/samples" />
      </copy>
      -->

      <!-- Package version specific samples configuration if requested -->
      <antcall target="package-samples-copy" inheritAll="true" inheritRefs="true"/>
   </target>

   <target name="package-version-checkdir">
      <condition property="pkg.version.hasdir">
          <available file="${maven.project.basedir}/src/main/resources/jpp/main" type="dir"/>
      </condition>
   </target>

    <target name="package-version-copy" depends="package-version-checkdir" if="pkg.version.hasdir">
        <copy todir="${jbossas.target.dir}" preservelastmodified="true" overwrite="true">
            <fileset dir="${maven.project.basedir}/src/main/resources/jpp/main"/>
        </copy>
    </target>

    <target name="package">

      <echo>Using JBoss AS at: ${jbossas.dir}</echo>

      <!-- Copy jboss -->
      <copy todir="${jbossas.target.dir}" preservelastmodified="true">
         <fileset dir="${jbossas.dir}"/>
      </copy>

      <!-- maven-ant integration - calling pom.xml dependencies as filesets -->
      <dependencyfilesets/>

      <!-- Copy gatein.ear -->

      <unzip dest="${jbossas.target.dir}/gatein/gatein.ear/eXoResources.war">
         <fileset refid="org.gatein.portal:exo.portal.web.eXoResources:war"/>
      </unzip>
      <unzip dest="${jbossas.target.dir}/gatein/gatein.ear/portal.war">
         <fileset refid="org.gatein.portal:exo.portal.web.portal:war"/>
      </unzip>
      <copy tofile="${jbossas.target.dir}/gatein/gatein.ear/dashboard.war" >
         <fileset refid="org.gatein.portal:exo.portal.portlet.dashboard:war"/>
      </copy>
      <copy tofile="${jbossas.target.dir}/gatein/gatein.ear/exoadmin.war" >
         <fileset refid="org.gatein.portal:exo.portal.portlet.exoadmin:war"/>
      </copy>
      <copy tofile="${jbossas.target.dir}/gatein/gatein.ear/redirect-admin.war">
        <fileset refid="org.gatein.portal.portlet:redirect-admin-ui:war"/>
      </copy>
      <copy tofile="${jbossas.target.dir}/gatein/gatein.ear/eXoGadgets.war" >
         <fileset refid="org.gatein.portal:exo.portal.eXoGadgets:war"/>
      </copy>
      <copy tofile="${jbossas.target.dir}/gatein/gatein.ear/gwtGadgets.war" >
         <fileset refid="org.gatein.portal:exo.portal.gwtGadgets:war"/>
      </copy>
      <copy tofile="${jbossas.target.dir}/gatein/gatein.ear/eXoGadgetServer.war" >
         <fileset refid="org.gatein.portal:exo.portal.gadgets-server:war"/>
      </copy>
      <copy tofile="${jbossas.target.dir}/gatein/gatein.ear/rest.war" >
         <fileset refid="org.gatein.portal:exo.portal.web.rest:war"/>
      </copy>
      <copy tofile="${jbossas.target.dir}/gatein/gatein.ear/web.war" >
         <fileset refid="org.gatein.portal:exo.portal.portlet.web:war"/>
      </copy>


      <!-- WSRP integration -->
      <unzip dest="${jbossas.target.dir}/gatein/extensions/gatein-wsrp-integration.ear/extension-war.war">
         <fileset refid="org.gatein.integration:extension-war:war"/>
      </unzip>
      <unzip dest="${jbossas.target.dir}/gatein/extensions/gatein-wsrp-integration.ear/wsrp-producer.war">
         <fileset refid="org.gatein.wsrp:wsrp-producer:war"/>
      </unzip>
      <unzip dest="${jbossas.target.dir}/gatein/extensions/gatein-wsrp-integration.ear/wsrp-admin-gui.war">
         <fileset refid="org.gatein.wsrp:wsrp-admin-gui:war"/>
      </unzip>

      <!-- Mobile Integration -->
      <unzip dest="${jbossas.target.dir}/gatein/extensions/gatein-mobile-integration.ear" overwrite="true">
         <fileset refid="org.gatein.portal:mobile-extension-ear:ear"/>
      </unzip>

      <!-- Deployment archives overrides -->
      <!-- Copy bin, modules, configuration files -->
      <copy todir="${jbossas.target.dir}" preservelastmodified="true" overwrite="true">
         <fileset dir="${maven.project.basedir}/src/main/resources/jboss/main" />
      </copy>

      <!-- Copy version specific bin, modules, configuration files -->
      <copy todir="${jbossas.target.dir}" preservelastmodified="true" overwrite="true">
         <fileset dir="${maven.project.basedir}/src/main/resources/jpp/main" />
      </copy>

      <!-- Copy modules -->
      <copy todir="${jbossas.target.dir}/modules" preservelastmodified="true" overwrite="true">
         <fileset dir="${maven.project.basedir}/../modules/target/${server.name}/gatein/modules" />
      </copy>

      <!-- Extract common config from packaging.common artifact to gatein/conf -->
      <unzip src="${org.exoplatform.gatein.portal:exo.portal.packaging.common:jar}" dest="${jbossas.target.dir}/standalone/configuration/gatein">
        <patternset>
          <exclude name="META-INF/"/>
        </patternset>
      </unzip>

      <!-- File permissions -->
      <!-- Excluded due to ARG_MAX limitation on Mac OS X -->
      <!--chmod perm="0644" type="file" dir="${jbossas.target.dir}" excludes="**/*.sh"/-->
      <chmod perm="0755" type="file" dir="${jbossas.target.dir}" includes="**/*.sh"/>

  </target>

  <target name="post-package">
      <!-- Patch JBAPP-104987 -->
      <copy tofile="${jbossas.target.dir}/modules/org/jboss/ws/cxf/jbossws-cxf-server/main/jbossws-cxf-server-4.0.6.GA-redhat-2-JBPAPP-10497.jar" preservelastmodified="true" overwrite="true" filtering="false">
        <fileset file="${maven.project.basedir}/src/main/patches/JBPAPP-10497/jbossws-cxf-server-4.0.6.GA-redhat-2-JBPAPP-10497.jar" />
      </copy>
      <copy tofile="${jbossas.target.dir}/modules/org/apache/cxf/impl/main/cxf-rt-frontend-simple-2.4.9-redhat-2-JBPAPP-10497.jar" preservelastmodified="true" overwrite="true" filtering="false">
        <fileset file="${maven.project.basedir}/src/main/patches/JBPAPP-10497/cxf-rt-frontend-simple-2.4.9-redhat-2-JBPAPP-10497.jar" />
      </copy>
      <copy tofile="${jbossas.target.dir}/modules/org/jboss/ws/cxf/jbossws-cxf-server/main/module.xml" preservelastmodified="true" overwrite="true" filtering="false">
        <fileset file="${maven.project.basedir}/src/main/patches/JBPAPP-10497/module-jbossws-cxf-server.xml" />
      </copy>
      <copy tofile="${jbossas.target.dir}/modules/org/apache/cxf/impl/main/module.xml" preservelastmodified="true" overwrite="true" filtering="false">
        <fileset file="${maven.project.basedir}/src/main/patches/JBPAPP-10497/module-apache-cxf-main.xml" />
      </copy>

     <!-- CVE-2012-3546 -->
     <copy tofile="${jbossas.target.dir}/modules/org/jboss/as/web/main/module.xml" preservelastmodified="true" overwrite="true" filtering="false">
       <fileset file="${maven.project.basedir}/src/main/patches/CVE-2012-3546/module.xml" />
     </copy>
     <copy tofile="${jbossas.target.dir}/modules/org/jboss/as/web/main/jbossweb-7.0.17.Final-redhat-1-JBPAPP6-1709.jar" preservelastmodified="true" overwrite="true" filtering="false">
       <fileset file="${maven.project.basedir}/src/main/patches/CVE-2012-3546/jbossweb-7.0.17.Final-redhat-1-JBPAPP6-1709.jar" />
     </copy>

     <!-- Move to new location -->
      <move file="${jbossas.target.dir}" tofile="${jbossas.target.dir}/jboss-jpp-6.0"/>

      <!-- Package SSO -->
      <unzip src="${org.gatein.sso:sso-packaging:zip}" dest="${jbossas.target.dir}"/>
      <move file="${jbossas.target.dir}/gatein-sso-${org.gatein.sso.version}" tofile="${jbossas.target.dir}/gatein-sso"/>

      <!-- Patch CVE-2012-5784 -->
      <copy tofile="${jbossas.target.dir}/gatein-sso/josso/gatein-josso-181/modules/org/gatein/sso/main/axis-1.4.jar" preservelastmodified="true" overwrite="true" filtering="false">
        <fileset file="${maven.project.basedir}/src/main/patches/CVE-2012-5784/axis-1.4-redhat-1.jar" />
      </copy>

    <!-- Package management -->
      <copy tofile="${jbossas.target.dir}/gatein-management/gatein-management-cli.war">
          <fileset file="${org.gatein.management:gatein-management-cli:war}" />
      </copy>
  </target>
</project>
